<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmoJ Web App</title>
    <style>
        /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: "Georgia", serif;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        /* è¦‹å‡ºã— */
        .heading {
            text-align: center;
            background: #553c9a;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .heading h1 {
            font-size: 2.5rem;
            margin: 0;
        }

        .heading p {
            font-size: 1.2rem;
            margin: 5px 0;
        }

        .heading a {
            color: #f1c40f;
            text-decoration: none;
            font-weight: bold;
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
        #drop-area {
            background-color: #fff8e1;
            border: 2px dashed #bb8c3f;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* ãŠã—ã‚ƒã‚Œãªå½± */
            transition: background-color 0.3s;
        }


        #drop-area:hover {
            background-color: #ffe5b4;
        }

        #drop-area input {
            margin-top: 10px;
        }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #canvas {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        /* ãƒœã‚¿ãƒ³ */
        .button-container {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .button-container button {
            padding: 10px 20px;
            border: none;
            background: #6a4f4b;
            color: white;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .button-container button:hover {
            background: #8e6758;
        }

        /* OCRçµæœã¨ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .ocr-contrainer {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            width: 100%;
        }

        .ocr-result-section, .form-section {
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            width: 45%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .ocr-result-section h3, .form-section h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #5d4037;
        }

        #ocrResult {
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 300px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        textarea {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-family: "Georgia", serif;
            font-size: 1rem;
        }

        .vertical-viewer { 
            writing-mode: vertical-rl;
            text-orientation: upright;
            white-space: pre-wrap;
            overflow-y: auto;
            font-family: 'Yu Mincho', 'MS Mincho', serif;
            font-size: 1.5rem;        /* âœ… JavaScriptã§å¯å¤‰å¯¾å¿œå¯èƒ½ï¼ˆåˆæœŸå€¤ï¼‰ */
            padding: 10px;
            line-height: 1.5;
            min-width: 150px;
            width: 100%;              /* âœ… è¦ªè¦ç´ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã«å¿œã˜ã¦æ‹¡å¼µ */
            height: 75%;             /* âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é«˜ã•ã«å¿œã˜ã¦ä¼¸ç¸® */
            border: 1px solid #ccc;
            background: #fdfdfd;
            box-sizing: border-box;   /* âœ… paddingã‚’å«ã‚ã¦ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã—ã‚„ã™ã */
        }

        #ocrModal {
            resize: both;
            overflow: auto;
            width: 400px;
            height: 600px;
            max-width: 90vw;
            max-height: 90vh;
        }

        input[type="submit"] {
            background: #7b1fa2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1rem;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        input[type="submit"]:hover {
            background: #9c27b0;
        }        
    </style>
</head>
<body>
    <div class="heading">
        <h1>ArmoJ Web App</h1>

        <p><a href="/images">Sample Images</a></p>
        <p><a href="https://docs.google.com/forms/d/e/1FAIpQLSfyCcKctOdYp0O7nt4SIO57T5Ly6ANP05_4yFzNHwewGn5z1w/viewform?usp=sf_link">Questionnaire(in Japanese)</a></p>
    </div>
    
    <!-- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
    <div id="drop-area">
        Drag and Drop an image here
        <br>OR
        <br>
        <input type="file" id="imageLoader" accept="application/pdf, image/*"/> 
    </div>

    <!-- PDFãƒšãƒ¼ã‚¸åˆ¶å¾¡ã®ãŸã‚ã®è¦ç´  -->
    <div id="page-control" style="text-align:center; margin-top:10px;">
        <label for="pageInput">Page: </label>
        <input type="number" id="pageInput" min="1" value="1" style="width: 60px;">
        <button onclick="changePage()">Go</button>
        <span id="pageDisplay"><span id="currentPageNum">1</span> / <span id="totalPageNum">1</span></span>
    </div>

    <!--11/28 -->
    <div id="pdf-page-controls" style="display: none; margin-top: 10px;">
        <button id="prevPage">Previous Page</button>
        <span id="pageInfo">Page <span id="currentPage"></span> of <span id="totalPages"></span></span>
        <button id="nextPage">Next Page</button>
    </div>
    

    <div class="container">
        <canvas id="canvas"></canvas>

        <!-- å›è»¢ãƒœã‚¿ãƒ³ -->
        <div class="button-container">
            <button onclick="rotateImage(-90)">â†º Rotate Left</button>
            <button onclick="rotateImage(-1)">-1Â°</button>
            <button onclick="rotateImage(1)">+1Â°</button>
            <button onclick="rotateImage(90)">â†» Rotate Right</button>
        </div>

        <!-- OCRå®Ÿè¡Œãƒœã‚¿ãƒ³ -->
        <div class="button-container">
            <button id="charocrBtn">Character Recognition</button>
            <button id="lineocrBtn">Line Recognition</button>
            <button id="pageocrBtn">Page Recognition</button>
            <button id="clearSelectionBtn">Clear Selection</button>
            <button id="toggleLbboxesBtn">Hide Boxes</button>
        </div>
    </div>

    <!-- ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³è¿½åŠ  -->
    <div style="margin-top: 10px; text-align: center;">
        <label><input type="radio" name="accuracy" value="standard" checked> Standard</label>
        <label><input type="radio" name="accuracy" value="high"> High Accuracy</label>
    </div>

    <!-- YOLO conf ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
    <div style="margin-top: 10px; text-align: center;">
        <label for="yoloConfSlider">YOLO Conf: <span id="yoloConfValue">0.25</span></label>
        <input type="range" id="yoloConfSlider" min="0.25" max="0.95" step="0.05" value="0.25"
            oninput="document.getElementById('yoloConfValue').innerText = parseFloat(this.value).toFixed(2)">
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="statusMessage" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
    
    <!-- OCRçµæœã®è¡¨ç¤º -->
    <div class="ocr-contrainer">
        <div class="ocr-result-section">
            <h3>OCR Result:</h3>
            <p id="ocrResult"></p>
        </div>

        <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤º -->
        <div class="form-section">
            <h3>Correct:</h3>
            <form action="/submit" method="POST">
                <!-- <input type="text" name="textbox" id="textbox" required> -->
                <textarea name="textbox" id='textbox' rows="10" cols="50" required></textarea>
                <input type="submit" id="submitBtn" value="é€ä¿¡">  
            </form>    
        </div>
    </div>

    <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ocrModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background-color: white; border: 2px solid #888; z-index: 9999; padding: 0; border-radius: 10px; box-shadow: 0 5px 10px rgba(0,0,0,0.3);">
        
        <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ¼ -->
        <div id="ocrModalHeader" style="cursor: move; background-color: #553c9a; color: white; padding: 10px; border-top-left-radius: 10px; border-top-right-radius: 10px;">
            OCR Result
        </div>

        <!-- ä¸­èº« -->
        <div style="padding: 20px;">
            <div id="ocrModalViewer" class="vertical-viewer" contenteditable="false"></div>
            <div style="text-align:right; margin-top: 10px;">
                <button onclick="changeFontSize(0.2)">A+</button>
                <button onclick="changeFontSize(-0.2)">Aâˆ’</button>                
                <button onclick="closeOcrModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="result"></div>

    <div id="pdf-list"></div>
    <div id="page-buttons"></div>
    <div id="ocrResult"></div>


    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var imageLoader = document.getElementById('imageLoader');
        var dropArea = document.getElementById('drop-area');
        var img = new Image();
        var newWidth, newHeight;
        var currentFile;
        var startX, startY, endX, endY, isDrawing = false;
        var hasSelection = false;
        var scaleFactor = 1;

        let currentFontSize = 1.5;
        function changeFontSize(delta) {
            currentFontSize = Math.max(0.5, currentFontSize + delta);
            document.getElementById('ocrModalViewer').style.fontSize = currentFontSize + 'rem';
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆdrop-areaã¨canvasä¸¡æ–¹ï¼‰
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            canvas.addEventListener(eventName, preventDefaults, false);
        });
        canvas.addEventListener('drop', handleDrop, false);

        // pdfå¯¾å¿œãƒ—ãƒ­ã‚°ãƒ©ãƒ è¿½åŠ  10.17
        const pdfViewer = document.getElementById("pdf-viewer");
        const ocrResult = document.getElementById("ocr-result");
        let pdfDocument = null;

        //PDFãƒšãƒ¼ã‚¸åˆ¶å¾¡ã®ãŸã‚ã®å¤‰æ•°
        let currentPage = 1;
        let totalPages = 0;

        let currentPageImageData = null;
        let currentRotation = 0;  // å›è»¢è§’åº¦ã‚’ä¿æŒ

        let showLbboxes = true;  // è¡¨ç¤ºçŠ¶æ…‹
        let currentLbboxes = [];  // ç›´è¿‘ã®lbboxesãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

        function renderPage(pageNum) {
            currentLbboxes = []; 
            if (!pdfDocument || pageNum < 1 || pageNum > totalPages) return;

            pdfDocument.getPage(pageNum).then((page) => {
                const cviewport = page.getViewport({ scale: 2.0 });
                let w = cviewport.width;
                let h = cviewport.height;

                let maxheight = 768;
                scaleFactor = 1;
                if (h > maxheight) {
                    scaleFactor = maxheight / h;
                }

                newWidth = w * scaleFactor;
                newHeight = h * scaleFactor;

                const viewport = page.getViewport({ scale: 2.0 * scaleFactor });

                // ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹
                const offCanvas = document.createElement('canvas');
                offCanvas.width = viewport.width;
                offCanvas.height = viewport.height;
                const offCtx = offCanvas.getContext('2d');

                page.render({ canvasContext: offCtx, viewport: viewport }).promise.then(() => {
                    // tempImg çµŒç”±ã§å›è»¢æç”»
                    const imgData = offCanvas.toDataURL();
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        currentPageImageData = imgData;  // ğŸ”„ å›è»¢å‰ã®ç”»åƒã§ã¯ã‚ã‚‹ãŒã€å›è»¢ç”¨ã¨ã—ã¦ä¿æŒ

                        drawRotatedImage(tempImg);  // âœ… ã“ã“ã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã«å›è»¢ã—ã¦æç”»

                        // ãƒšãƒ¼ã‚¸ç•ªå·æ›´æ–°
                        document.getElementById("currentPageNum").innerText = pageNum;
                        document.getElementById("totalPageNum").innerText = totalPages;
                    };
                    tempImg.src = imgData;
                });
            });
        }


        function changePage() {
            let inputPage = parseInt(document.getElementById("pageInput").value);
            if (inputPage >= 1 && inputPage <= totalPages) {
                currentRotation = 0;
                currentPage = inputPage;
                renderPage(currentPage);
            } else {
                alert(`ãƒšãƒ¼ã‚¸ç•ªå·ã¯ 1 ã€œ ${totalPages} ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`);
            }
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            console.log("handleDrop");
            preventDefaults(e);
            var dt = e.dataTransfer;
            var file = dt.files[0];
            currentFile = file;
            handleFile(file);
        }

        imageLoader.addEventListener('change', function(e) {
            console.log("imageLoader");          
            var file = e.target.files[0];
            currentFile = file;
            handleFile(file);
        });

        function handleFile(file) {
            console.log(file.type);
            currentFile = file;
            currentPage = 1; // â† ã“ã“ã‚’æ˜ç¤ºã—ã¦ãŠãã¨å®‰å…¨

            if (file) {
                if (file.type == "application/pdf") {
                    handlePdfFile(file);
                }
                else if (file.type.match(/image\/*/)) {
                    handleImageFile(file);
                }
            } else {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        }

        function handleImageFile(file) {
            console.log("handleImageFile");
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            currentLbboxes = [];  // ç¾åœ¨ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            var reader = new FileReader();
            reader.onload = function(event) {
                img.onload = function() {
                    currentRotation = 0;  // å›è»¢ãƒªã‚»ãƒƒãƒˆ
                    var maxheight = 768;
                    scaleFactor = 1;

                    if (img.height > maxheight) {
                        scaleFactor = maxheight / img.height;
                    }

                    console.log(img.width, img.height);
                    newWidth = img.width * scaleFactor;
                    newHeight = img.height * scaleFactor;

                    // âœ… currentPageImageData ã‚’ img ã‹ã‚‰å–å¾—
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = newWidth;
                    tempCanvas.height = newHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(img, 0, 0, newWidth, newHeight);
                    currentPageImageData = tempCanvas.toDataURL();

                    drawRotatedImage(img);  // â† å›è»¢ã‚’åæ˜ ã—ã¦æç”»

                    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæƒ…å ±
                    document.getElementById("currentPageNum").innerText = 1;
                    document.getElementById("totalPageNum").innerText = 1;
                    document.getElementById("pageInput").value = 1;
                };

                img.src = event.target.result;
            };

            reader.readAsDataURL(file);
        }



        function handlePdfFile(file) {
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            currentLbboxes = [];
            currentRotation = 0;

            const reader = new FileReader();

            reader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                pdfjsLib.getDocument(typedarray).promise.then((pdf) => {
                    pdfDocument = pdf;
                    totalPages = pdf.numPages;
                    currentPage = 1;

                    // âœ… è¡¨ç¤ºã‚’ã“ã“ã§æ›´æ–°
                    document.getElementById("currentPageNum").innerText = currentPage;
                    document.getElementById("totalPageNum").innerText = totalPages;
                    document.getElementById("pageInput").value = currentPage;

                    renderPage(currentPage);
                    // renderPdf();
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã§é¸æŠç¯„å›²ã‚’æç”»
        canvas.addEventListener('mousedown', function(e) {
            isDrawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
        });

        canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
                endX = e.offsetX;
                endY = e.offsetY;
                redrawCanvas();
                drawRectangle();
            }
        });

        canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;
            endX = e.offsetX;
            endY = e.offsetY;
            hasSelection = true;
        });

        function drawRotatedImage(image) {
            const imgWidth = newWidth;
            const imgHeight = newHeight;
            const rad = currentRotation * Math.PI / 180;

            // ä»»æ„è§’åº¦ã«å¯¾å¿œã—ãŸã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨ˆç®—
            const rotW = Math.abs(imgWidth * Math.cos(rad)) + Math.abs(imgHeight * Math.sin(rad));
            const rotH = Math.abs(imgWidth * Math.sin(rad)) + Math.abs(imgHeight * Math.cos(rad));

            canvas.width = Math.ceil(rotW);
            canvas.height = Math.ceil(rotH);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(rad);
            ctx.drawImage(image, -imgWidth / 2, -imgHeight / 2, imgWidth, imgHeight);
            ctx.restore();
        }

        function drawBoundingBoxes(lbboxes) {
            // ä¸€åº¦å…ƒç”»åƒã‚’å†æç”»ã—ã¦ã‹ã‚‰çŸ©å½¢ã‚’æã
            if (!currentPageImageData) return;

            currentLbboxes = lbboxes;  // ç¾åœ¨ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ä¿æŒ

            const tempImg = new Image();
            tempImg.onload = function () {
                // å›è»¢è¾¼ã¿ã§å†æç”»
                drawRotatedImage(tempImg);

                if (!showLbboxes) return;  // éè¡¨ç¤ºãªã‚‰çµ‚äº†

                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;

                lbboxes.forEach(box => {
                    const x = box[0];
                    const y = box[1];
                    const w = (box[2] - box[0]);
                    const h = (box[3] - box[1]);
                    ctx.strokeRect(x, y, w, h);
                });
            };
            tempImg.src = currentPageImageData;
        }

        

        function redrawCanvas() {
            if (!currentPageImageData) return;
            
            const tempImg = new Image();
            tempImg.onload = function () {
                // å›è»¢ã‚‚åæ˜ ã™ã‚‹ã‚ˆã†ã«æç”»
                drawRotatedImage(tempImg);
                drawRectangle();
            };
            tempImg.src = currentPageImageData;
        }

        function drawRectangle() {
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        }

        function rotateImage(angle) {
            currentRotation = (currentRotation + angle + 360) % 360;
            redrawCanvasWithRotation();  // â† å¸¸ã« currentPageImageData ã‚’ä½¿ã†
        }

        function redrawCanvasWithRotation() {
            if (!currentPageImageData) return;

            const tempImg = new Image();
            tempImg.onload = function () {
                drawRotatedImage(tempImg);
            };
            tempImg.src = currentPageImageData;
            drawBoundingBoxes(currentLbboxes);
        }



        // è¿½åŠ 
        /* æœ€åˆã¯ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã¯éè¡¨ç¤ºã«ã™ã‚‹ */
        function showTextbox() {
            document.getElementById('text-section').style.display = 'block';
        } 


        var charocrBtn = document.getElementById('charocrBtn');
        var lineocrBtn = document.getElementById('lineocrBtn');
        var pageocrBtn = document.getElementById('pageocrBtn');
        var clearSelectionBtn = document.getElementById('clearSelectionBtn');
        var submitBtn = document.getElementById('submitBtn');
        var toggleLbboxesBtn = document.getElementById('toggleLbboxesBtn');

        clearSelectionBtn.addEventListener('click', function() {
            hasSelection = false;
            startX = undefined;
            startY = undefined;
            endX = undefined;
            endY = undefined;
            redrawCanvasWithRotation();
        });

        // OCRå‰ã«ç¾åœ¨ã®canvaså†…å®¹ã‚’ç”»åƒã«å¤‰æ›ã—ã¦é€ã‚‹
        function getCanvasAsBlob() {
            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    resolve(blob);
                }, 'image/png');
            });
        }

        // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãªã—ã®å…ƒç”»åƒã‹ã‚‰Blobã‚’ç”Ÿæˆï¼ˆPage Recognitionç”¨ï¼‰
        function getOriginalImageAsBlob() {
            return new Promise(resolve => {
                if (!currentPageImageData) {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç¾åœ¨ã®canvasã‚’ãã®ã¾ã¾ä½¿ã†
                    canvas.toBlob(blob => resolve(blob), 'image/png');
                    return;
                }
                const tempImg = new Image();
                tempImg.onload = function() {
                    const tmpCanvas = document.createElement('canvas');
                    const tmpCtx = tmpCanvas.getContext('2d');
                    tmpCanvas.width = canvas.width;
                    tmpCanvas.height = canvas.height;
                    // å›è»¢ã‚’åæ˜ ã—ã¦å…ƒç”»åƒã‚’æç”»ï¼ˆãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãªã—ï¼‰
                    const rad = currentRotation * Math.PI / 180;
                    tmpCtx.translate(tmpCanvas.width / 2, tmpCanvas.height / 2);
                    tmpCtx.rotate(rad);
                    tmpCtx.drawImage(tempImg, -newWidth / 2, -newHeight / 2, newWidth, newHeight);
                    tmpCanvas.toBlob(blob => resolve(blob), 'image/png');
                };
                tempImg.src = currentPageImageData;
            });
        }

        // OCRã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†
        charocrBtn.addEventListener('click', async function() {
            if (!hasSelection || !isFinite(startX) || !isFinite(endX)) {
                alert('Please draw a rectangle to select a region first.');
                return;
            }
            var x = Math.min(startX, endX);
            var y = Math.min(startY, endY);
            var width = Math.abs(endX - startX);
            var height = Math.abs(endY - startY);

            var formData = new FormData();
            formData.append('scaleFactor', scaleFactor);
            formData.append('x', x);
            formData.append('y', y);
            formData.append('width', width);
            formData.append('height', height);
            formData.append('canvas_w', canvas.width);
            formData.append('canvas_h', canvas.height);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å†…å®¹ã‚’Blobã¨ã—ã¦å–å¾—
            const canvasBlob = await getCanvasAsBlob();
            formData.append('file', canvasBlob, 'canvas.png');

            fetch('/run_charocr', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('ocrResult').innerText = data.ocr_text;
                    document.getElementById('textbox').value = data.ocr_text;  // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«çµæœã‚’åæ˜ 
                    showOcrModal(data.ocr_text);
                    console.log(data.status)
                    //console.log(data.ocr_text);
                } else {
                    alert(data.message);
                }
            });
        });

        lineocrBtn.addEventListener('click', async function() {
            if (!hasSelection || !isFinite(startX) || !isFinite(endX)) {
                alert('Please draw a rectangle to select a region first.');
                return;
            }
            var x = Math.min(startX, endX);
            var y = Math.min(startY, endY);
            var width = Math.abs(endX - startX);
            var height = Math.abs(endY - startY);

            var formData = new FormData();
            formData.append('scaleFactor', scaleFactor);
            formData.append('x', x);
            formData.append('y', y);
            formData.append('width', width);
            formData.append('height', height);
            formData.append('canvas_w', canvas.width);
            formData.append('canvas_h', canvas.height);

            // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’è¿½åŠ ï¼ˆç”»åƒã®å ´åˆã¯1ãƒšãƒ¼ã‚¸ç›®ï¼‰
            formData.append('page', currentPage);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å†…å®¹ã‚’Blobã¨ã—ã¦å–å¾—
            const canvasBlob = await getCanvasAsBlob();
            formData.append('file', canvasBlob, 'canvas.png');

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®é¸æŠå€¤ã‚’è¿½åŠ 
            const accuracy = document.querySelector('input[name="accuracy"]:checked').value;
            formData.append('accuracy', accuracy); 

            fetch('/run_lineocr', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('ocrResult').innerText = data.ocr_text;
                    document.getElementById('textbox').value = data.ocr_text;
                    showOcrModal(data.ocr_text);
                    console.log(data.status)
                } else {
                    alert(data.message);
                }
            });
        });

        pageocrBtn.addEventListener('click', async function() {
            var formData = new FormData();

            // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’è¿½åŠ ï¼ˆç”»åƒã®å ´åˆã¯1ãƒšãƒ¼ã‚¸ç›®ï¼‰
            formData.append('page', currentPage);

            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠå€¤ã‚’è¿½åŠ 
            const accuracy = document.querySelector('input[name="accuracy"]:checked').value;
            formData.append('accuracy', accuracy);

            // YOLO confå€¤ã‚’è¿½åŠ 
            const yoloConf = document.getElementById('yoloConfSlider').value;
            formData.append('yolo_conf', yoloConf);

            // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆã€åº§æ¨™ã‚’é€ä¿¡ï¼ˆåº§æ¨™ãŒæœ‰åŠ¹ãªæ•°å€¤ã®å ´åˆã®ã¿ï¼‰
            if (hasSelection && isFinite(startX) && isFinite(startY) && isFinite(endX) && isFinite(endY)) {
                var selX = Math.min(startX, endX);
                var selY = Math.min(startY, endY);
                var selW = Math.abs(endX - startX);
                var selH = Math.abs(endY - startY);
                if (selW > 0 && selH > 0) {
                    formData.append('sel_x', selX);
                    formData.append('sel_y', selY);
                    formData.append('sel_width', selW);
                    formData.append('sel_height', selH);
                }
            }

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãªã—ã®å…ƒç”»åƒã‹ã‚‰Blobã‚’ç”Ÿæˆ
            const canvasBlob = await getOriginalImageAsBlob();
            formData.append('file', canvasBlob, 'canvas.png');

            // âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–‹å§‹
            const statusDiv = document.getElementById('statusMessage');
            let dots = '';
            statusDiv.innerText = 'Please wait';
            const statusInterval = setInterval(() => {
                dots = dots.length >= 3 ? '' : dots + '.';
                statusDiv.innerText = 'Please wait' + dots;
            }, 500);

            fetch('/run_pageocr', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('ocrResult').innerText = data.ocr_text;
                    document.getElementById('textbox').value = data.ocr_text;
                    showOcrModal(data.ocr_text);
                    console.log(data.status)
                    if (data.lbboxes) {
                        drawBoundingBoxes(data.lbboxes);
                    }
                    // èªè­˜å®Œäº†å¾Œã«é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    hasSelection = false;
                } else {
                    alert(data.message);
                }
            })
            .finally(() => {
                clearInterval(statusInterval);
                statusDiv.innerText = 'Done';
                
                // âœ… OCRå¾Œã«ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’å†è¡¨ç¤ºï¼ˆPDFãªã‚‰ï¼‰
                if (pdfDocument) {
                    document.getElementById("currentPageNum").innerText = currentPage;
                    document.getElementById("totalPageNum").innerText = totalPages;
                    document.getElementById("pageInput").value = currentPage;
                }
            });
        });
        
        // ä¸Šã«ç¿’ã„è¿½åŠ 
        // var submitBtn = document.getElementById('submitBtn');
        submitBtn.addEventListener('click', function(event) {
            event.preventDefault();            
            
            var formData = new FormData(event.target.form);

            fetch('/submit', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('ocrResult').innerText = data.ocr_text;
                    document.getElementById('textbox').value = data.ocr_text;
                    console.log(data.status)
                } else {
                    alert(data.message);
                }
            })
        });

        toggleLbboxesBtn.addEventListener('click', function() {
            showLbboxes = !showLbboxes;
            toggleLbboxesBtn.innerText = showLbboxes ? 'Hide Boxes' : 'Show Boxes';

            if (showLbboxes && currentLbboxes.length > 0) {
                drawBoundingBoxes(currentLbboxes);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                redrawCanvasWithRotation();  // å›è»¢ã‚’åæ˜ ã—ã¦å†æç”»
            }
        });

        function showOcrModal(text) {
            document.getElementById('ocrModalViewer').innerText = text;
            document.getElementById('ocrModal').style.display = 'block';
        }

        function closeOcrModal() {
            document.getElementById('ocrModal').style.display = 'none';
        }

        function makeModalDraggable(modal, header) {
            let offsetX = 0, offsetY = 0, startX = 0, startY = 0;

            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                startX = e.clientX;
                startY = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                offsetX = e.clientX - startX;
                offsetY = e.clientY - startY;
                startX = e.clientX;
                startY = e.clientY;

                modal.style.top = (modal.offsetTop + offsetY) + "px";
                modal.style.left = (modal.offsetLeft + offsetX) + "px";
                modal.style.transform = ""; // ä¸­å¤®æƒãˆã®transformã‚’ç„¡åŠ¹ã«ã™ã‚‹
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        window.onload = function () {
            const modal = document.getElementById("ocrModal");
            const header = document.getElementById("ocrModalHeader");
            makeModalDraggable(modal, header);
        };

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</body>
</html>
