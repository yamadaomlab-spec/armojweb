<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像切り抜きアプリ</title>
    <style>
        #canvas { border: 1px solid black; }
        #drop-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>画像切り抜きアプリ</h1>

    <!-- ドラッグ＆ドロップエリア -->
    <div id="drop-area">
        ここに画像をドラッグ＆ドロップしてください
        <br>または
        <br>
        <input type="file" id="imageLoader" accept="image/*"/>
    </div>

    <canvas id="canvas"></canvas>

    <!-- 切り抜きボタン -->
    <button id="cropBtn">画像を切り抜く</button>

    <!-- OCR実行ボタン -->
    <button id="ocrBtn" disabled>行画像認識を実行する</button>

    <!-- OCR結果の表示 -->
    <h3>OCR結果:</h3>
    <p id="ocrResult"></p>

    <!-- 切り抜いた画像の表示 -->
    <h3>切り抜いた画像:</h3>
    <img id="croppedImage" src="" alt="ここに切り抜かれた画像が表示されます"/>

    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var imageLoader = document.getElementById('imageLoader');
        var dropArea = document.getElementById('drop-area');
        var img = new Image();
        var currentFile;
        var startX, startY, endX, endY, isDrawing = false;

        // ドラッグ＆ドロップのイベントリスナーを追加
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            preventDefaults(e);
            var dt = e.dataTransfer;
            var file = dt.files[0];
            if (file) {
                currentFile = file;
                handleImageFile(file);
            } else {
                console.log('ファイルがドロップされていません');
            }
        }

        imageLoader.addEventListener('change', function(e) {
            var file = e.target.files[0];
            currentFile = file;
            handleImageFile(file);
        });

        function handleImageFile(file) {
            if (!file) {
                alert('ファイルが選択されていません');
                return;
            }
            var reader = new FileReader();
            reader.onload = function(event) {
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // マウスイベントで選択範囲を描画
        canvas.addEventListener('mousedown', function(e) {
            isDrawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
        });

        canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
                endX = e.offsetX;
                endY = e.offsetY;
                redrawCanvas();
                drawRectangle();
            }
        });

        canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;
            endX = e.offsetX;
            endY = e.offsetY;
        });

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        }

        function drawRectangle() {
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        }

        var cropBtn = document.getElementById('cropBtn');
        var ocrBtn = document.getElementById('ocrBtn');
        
        // 画像を切り抜く処理
        cropBtn.addEventListener('click', function() {
            var x = Math.min(startX, endX);
            var y = Math.min(startY, endY);
            var width = Math.abs(endX - startX);
            var height = Math.abs(endY - startY);

            var croppedData = canvas.getContext('2d').getImageData(x, y, width, height);
            var croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = width;
            croppedCanvas.height = height;
            croppedCanvas.getContext('2d').putImageData(croppedData, 0, 0);

            croppedCanvas.toBlob(function(blob) {
                var formData = new FormData();
                formData.append('x', x);
                formData.append('y', y);
                formData.append('width', width);
                formData.append('height', height);
                formData.append('image', currentFile);

                fetch('/crop_image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        var timestamp = new Date().getTime();
                        document.getElementById('croppedImage').src = data.cropped_image_url + '?t=' + timestamp;
                        ocrBtn.disabled = false;  // OCRボタンを有効にする
                    } else {
                        alert(data.message);
                    }
                });
            });
        });

        // OCRを実行する処理
        ocrBtn.addEventListener('click', function() {
            var x = Math.min(startX, endX);
            var y = Math.min(startY, endY);
            var width = Math.abs(endX - startX);
            var height = Math.abs(endY - startY);

            var formData = new FormData();
            formData.append('x', x);
            formData.append('y', y);
            formData.append('width', width);
            formData.append('height', height);
            formData.append('image', currentFile);

            fetch('/run_ocr', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('ocrResult').innerText = data.ocr_text;
                    console.log(data.status)
                } else {
                    alert(data.message);
                }
            });
        });
    </script>
</body>
</html>
